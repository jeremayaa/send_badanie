{% extends 'core/base.html' %}
{% load static %}
{% block title %}Badania{% endblock %}
{% block content %}
  <h2>Badania</h2>

  <link rel="stylesheet" href="{% static 'css/lists.css' %}">

  <div class="list-layout">
    <!-- Left column: Controls -->
    <div class="sidebar">
      <p>
        <button id="toggle-filter-btn">Filtruj po tagach</button><br><br>
        <button id="sort-name">Sortuj wg nazw</button><br><br>
        <button id="sort-date">Sortuj wg daty</button>
      </p>

      <div id="filter-container" style="display:none; margin-top: 1em;">
        {% for tag in all_tags %}
          <label>
            <input type="checkbox" value="{{ tag.pk }}" class="filter-tag">
            {{ tag.nazwa }}
          </label><br>
        {% endfor %}
      </div>
    </div>

    <!-- Right column: Data table -->
    <div class="list-content">
      <table id="badania-table" class="data-table">
        <thead>
          <tr>
            <th class="mini">Miniatura</th>
            <th>Nazwa</th>
            <th class="date">Data</th>
          </tr>
        </thead>
        <tbody id="badania-list"></tbody>
      </table>

      <div class="pagination-controls">
        <button id="prev-page" disabled>« Poprzednia</button>
        <button id="next-page" disabled>Następna »</button>
      </div>
    </div>
  </div>

  <script>
    const listEl = document.getElementById('badania-list');
    const toggler = document.getElementById('toggle-filter-btn');
    const filtBox = document.getElementById('filter-container');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');

    const pageSize = 5;
    let currentPage = 1;
    let ordering = '-data';  // default ordering

    toggler.onclick = () => {
      filtBox.style.display = filtBox.style.display === 'none' ? 'block' : 'none';
    };

    const checkTags = () => [...document.querySelectorAll('.filter-tag')]
      .filter(i => i.checked)
      .map(i => i.value);

    function updatePaginationButtons(totalCount) {
      const maxPage = Math.ceil(totalCount / pageSize);
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= maxPage;
    }

    function loadBadania() {
      const params = new URLSearchParams();
      checkTags().forEach(id => params.append('tagi', id));
      params.append('ordering', ordering);
      params.append('limit', pageSize);
      params.append('offset', (currentPage - 1) * pageSize);

      fetch(`/api/badania/?${params.toString()}`, {
        headers: { 'Accept': 'application/json' }
      })
      .then(r => r.json())
      .then(data => {
        listEl.innerHTML = '';
        if (!data.results || data.results.length === 0) {
          listEl.innerHTML = '<tr><td colspan="3">Brak badań.</td></tr>';
          updatePaginationButtons(0);
          return;
        }

        data.results.forEach(b => {
          const tr = document.createElement('tr');
          tr.className = 'clickable-row';
          tr.onclick = () => window.location.href = `/badania/${b.id}/`;

          tr.innerHTML = `
            <td class="mini">
              ${b.zdjecie ? `<img src="${b.zdjecie}" alt="miniatura" class="miniature">` : ''}
            </td>
            <td>${b.nazwa}</td>
            <td class="date">${b.data}</td>
          `;
          listEl.appendChild(tr);
        });

        updatePaginationButtons(data.count);
      });
    }

    // Sorting buttons
    document.getElementById('sort-name').onclick = () => {
      ordering = 'nazwa';
      currentPage = 1;
      loadBadania();
    };

    document.getElementById('sort-date').onclick = () => {
      ordering = '-data';
      currentPage = 1;
      loadBadania();
    };

    // Filter change
    document.querySelectorAll('.filter-tag').forEach(cb => {
      cb.onchange = () => {
        currentPage = 1;
        loadBadania();
      };
    });

    // Pagination
    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        loadBadania();
      }
    };

    nextBtn.onclick = () => {
      currentPage++;
      loadBadania();
    };

    window.addEventListener('DOMContentLoaded', loadBadania);
  </script>
{% endblock %}
