{% extends 'core/base.html' %}
{% block title %}{{ title }} – analiza w programie{% endblock %}
{% block content %}
  <h2 style="text-align:center;">Programowa analiza: {{ title }}</h2>

  <div id="canvas-container"
       style="position:relative; margin:0 auto; background:#eee;">
    <canvas id="baseCanvas" style="width:100%; height:100%; display:block;"></canvas>
    <canvas id="overlayCanvas"
            style="position:absolute; top:0; left:0;
                   width:100%; height:100%; pointer-events:auto;">
    </canvas>
  </div>

  <p style="text-align:center; margin-top:0.5em;">
    <button id="bw-btn">Czarnobiałe</button>
    <button id="pen-btn">Pisak</button>
    <button id="eraser-btn">Gumka</button>
    <button id="save-btn">Zapisz maskę</button>
  </p>

  <img id="orig-img" src="{{ base_image_url }}" style="display:none;">
  {% if overlay_image_url %}
    <img id="mask-img" src="{{ overlay_image_url }}" style="display:none;">
  {% endif %}

  <script>
    const img      = document.getElementById('orig-img');
    const maskImg  = document.getElementById('mask-img');
    const base     = document.getElementById('baseCanvas');
    const over     = document.getElementById('overlayCanvas');
    const container= document.getElementById('canvas-container');
    const bctx     = base.getContext('2d');
    const octx     = over.getContext('2d');

    let tool = 'pen', drawing = false;
    const penSize = 5;

    function setupCanvases(w, h) {
      // wymiar atrybutów
      base.width = over.width = w;
      base.height= over.height= h;
      // styl kontenera
      container.style.width  = w + 'px';
      container.style.height = h + 'px';
      // przygotuj contexty
      bctx.lineCap = bctx.lineJoin = 'round';
      octx.lineCap = octx.lineJoin = 'round';
      octx.lineWidth = penSize;
      octx.strokeStyle = 'white';
    }

    img.onload = () => {
      const maxW = window.innerWidth * 0.9;
      const maxH = window.innerHeight * 0.7;
      const ratio = Math.min(maxW/img.naturalWidth, maxH/img.naturalHeight,1);
      const w = img.naturalWidth * ratio;
      const h = img.naturalHeight * ratio;
      setupCanvases(w, h);
      // narysuj tło
      bctx.drawImage(img,0,0,w,h);
      // jeśli edycja: nałóż istniejącą maskę
      {% if overlay_image_url %}
        maskImg.onload = () => {
          octx.drawImage(maskImg,0,0,over.width,over.height);
        };
      {% endif %}
    };

    document.getElementById('bw-btn').onclick = () => {
      bctx.filter = 'grayscale(100%)';
      bctx.drawImage(img,0,0,base.width,base.height);
      bctx.filter = 'none';
    };
    document.getElementById('pen-btn').onclick = () => {
      tool = 'pen';
      octx.globalCompositeOperation = 'source-over';
    };
    document.getElementById('eraser-btn').onclick = () => {
      tool = 'eraser';
      octx.globalCompositeOperation = 'destination-out';
    };

    // rysowanie na overlay
    over.addEventListener('mousedown', e => {
      drawing = true;
      const rect = over.getBoundingClientRect();
      const x = (e.clientX - rect.left)*(over.width/rect.width);
      const y = (e.clientY - rect.top)*(over.height/rect.height);
      octx.beginPath();
      octx.moveTo(x,y);
    });
    over.addEventListener('mousemove', e => {
      if (!drawing) return;
      const rect = over.getBoundingClientRect();
      const x = (e.clientX - rect.left)*(over.width/rect.width);
      const y = (e.clientY - rect.top)*(over.height/rect.height);
      octx.lineTo(x,y);
      octx.stroke();
    });
    ['mouseup','mouseleave'].forEach(evt =>
      over.addEventListener(evt, () => drawing = false)
    );

    // zapis maski (tylko overlay)
    document.getElementById('save-btn').onclick = () => {
      const dataURL = over.toDataURL('image/png');
      localStorage.setItem('bwImage', dataURL);
      window.location.href = "{{ redirect_url }}";
    };
  </script>
{% endblock %}
