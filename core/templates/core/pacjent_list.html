{% extends 'core/base.html' %}
{% load static %}
{% block title %}Pacjenci{% endblock %}
{% block content %}
  <h2>Pacjenci</h2>

  <link rel="stylesheet" href="{% static 'css/lists.css' %}">

  <div class="list-layout" style="flex-direction: row-reverse;">
    <!-- Left: Table of patients -->
    <div class="list-content">
      <table id="pacjenci-table" class="data-table">
        <thead>
          <tr>
            <th class="mini">Miniatura</th>
            <th>Imię i nazwisko</th>
            <th class="add">Akcja</th>
          </tr>
        </thead>
        <tbody id="pacjenci-list"></tbody>
      </table>

      <div class="pagination-controls">
        <button id="prev-page" disabled>« Poprzednia</button>
        <button id="next-page" disabled>Następna »</button>
      </div>
    </div>

    <!-- Right: Buttons -->
    <div class="sidebar">
      <p>
        <button id="sort-first">Sortuj wg imion</button><br><br>
        <button id="sort-last">Sortuj wg nazwisk</button><br><br>
        <button id="sort-latest">Sortuj wg ostatniego badania</button><br><br>
        <a href="{% url 'core:pacjent-add' %}" class="add-button">+ Dodaj pacjenta</a>
      </p>
    </div>
  </div>

  <script>
    const listEl = document.getElementById('pacjenci-list');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');

    let ordering = 'nazwisko';
    let currentPage = 1;
    const pageSize = 5;

    function updatePaginationButtons(totalCount) {
      const maxPage = Math.ceil(totalCount / pageSize);
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= maxPage;
    }

    function loadPacjenci() {
      const params = new URLSearchParams();
      params.append('ordering', ordering);
      params.append('scope', 'mine');
      params.append('limit', pageSize);
      params.append('offset', (currentPage - 1) * pageSize);

      fetch(`/api/pacjenci/?${params}`, {
        headers: { 'Accept': 'application/json' }
      })
      .then(r => r.json())
      .then(data => {
        listEl.innerHTML = '';
        if (!data.results || data.results.length === 0) {
          listEl.innerHTML = '<tr><td colspan="3">Brak pacjentów.</td></tr>';
          updatePaginationButtons(0);
          return;
        }

        data.results.forEach(p => {
          const tr = document.createElement('tr');
          tr.className = 'clickable-row';
          tr.onclick = () => window.location.href = `/pacjenci/${p.id}/`;

          tr.innerHTML = `
            <td class="mini">
              <img src="/static/usericon.png" alt="miniatura" class="pacjent-mini">
            </td>
            <td>${p.imie} ${p.nazwisko}</td>
            <td class="add">
              <a href="/badania/dodaj/?pacjent=${p.id}" class="add-button" onclick="event.stopPropagation()">Dodaj badanie</a>
            </td>
          `;
          listEl.appendChild(tr);
        });

        updatePaginationButtons(data.count);
      });
    }

    document.getElementById('sort-first').onclick = () => {
      ordering = 'imie';
      currentPage = 1;
      loadPacjenci();
    };

    document.getElementById('sort-last').onclick = () => {
      ordering = 'nazwisko';
      currentPage = 1;
      loadPacjenci();
    };

    document.getElementById('sort-latest').onclick = () => {
      ordering = '-latest_badanie';
      currentPage = 1;
      loadPacjenci();
    };

    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        loadPacjenci();
      }
    };

    nextBtn.onclick = () => {
      currentPage++;
      loadPacjenci();
    };

    window.addEventListener('DOMContentLoaded', loadPacjenci);
  </script>
{% endblock %}
